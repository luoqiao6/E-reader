<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”µå­ä¹¦é˜…è¯»å™¨ - æ•°æ®åº“è°ƒè¯•å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      padding: 24px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 {
      font-size: 24px;
      margin-bottom: 24px;
      color: #333;
    }

    h2 {
      font-size: 18px;
      margin: 24px 0 12px;
      color: #555;
      border-bottom: 2px solid #eee;
      padding-bottom: 8px;
    }

    button {
      padding: 12px 24px;
      background-color: #000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 12px;
      margin-bottom: 12px;
    }

    button:hover {
      opacity: 0.9;
    }

    button.danger {
      background-color: #dc2626;
    }

    button.secondary {
      background-color: #6b7280;
    }

    .info-box {
      background-color: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 4px;
      padding: 16px;
      margin: 12px 0;
    }

    .error-box {
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 4px;
      padding: 16px;
      margin: 12px 0;
      color: #dc2626;
    }

    .success-box {
      background-color: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 4px;
      padding: 16px;
      margin: 12px 0;
      color: #16a34a;
    }

    pre {
      background-color: #1e293b;
      color: #e2e8f0;
      padding: 16px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background-color: #f9fafb;
      font-weight: 600;
      color: #374151;
    }

    tr:hover {
      background-color: #f9fafb;
    }

    .stat {
      display: inline-block;
      background-color: #eff6ff;
      padding: 8px 16px;
      border-radius: 4px;
      margin-right: 12px;
      margin-bottom: 12px;
    }

    .stat-label {
      font-size: 12px;
      color: #6b7280;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #1f2937;
    }

    #result {
      margin-top: 24px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š ç”µå­ä¹¦é˜…è¯»å™¨ - æ•°æ®åº“è°ƒè¯•å·¥å…·</h1>

    <div class="info-box">
      <strong>è¯´æ˜ï¼š</strong>æ­¤å·¥å…·ç”¨äºæ£€æŸ¥å’Œç®¡ç† IndexedDB ä¸­çš„ä¹¦ç±æ•°æ®ã€‚
    </div>

    <h2>ğŸ“Š æ•°æ®åº“ç»Ÿè®¡</h2>
    <div id="stats"></div>

    <h2>ğŸ› ï¸ æ“ä½œ</h2>
    <button onclick="checkDatabase()">æ£€æŸ¥æ•°æ®åº“</button>
    <button onclick="listBooks()">åˆ—å‡ºæ‰€æœ‰ä¹¦ç±</button>
    <button onclick="checkBookContent()">æ£€æŸ¥ä¹¦ç±å†…å®¹</button>
    <button class="secondary" onclick="exportData()">å¯¼å‡ºæ•°æ®ï¼ˆJSONï¼‰</button>
    <button class="danger" onclick="clearDatabase()">æ¸…ç©ºæ•°æ®åº“</button>

    <h2>ğŸ“‹ ç»“æœ</h2>
    <div id="result"></div>
  </div>

  <script>
    const DB_NAME = 'ebook-reader-db';
    const DB_VERSION = 1;

    // æ‰“å¼€æ•°æ®åº“
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // æ£€æŸ¥æ•°æ®åº“
    async function checkDatabase() {
      const result = document.getElementById('result');
      result.innerHTML = '<div class="info-box">æ­£åœ¨æ£€æŸ¥æ•°æ®åº“...</div>';

      try {
        const db = await openDB();
        const objectStoreNames = Array.from(db.objectStoreNames);
        
        result.innerHTML = `
          <div class="success-box">
            <strong>âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ</strong><br>
            æ•°æ®åº“åç§°: ${db.name}<br>
            æ•°æ®åº“ç‰ˆæœ¬: ${db.version}<br>
            å¯¹è±¡å­˜å‚¨: ${objectStoreNames.join(', ')}
          </div>
        `;

        db.close();
        await showStats();
      } catch (error) {
        result.innerHTML = `
          <div class="error-box">
            <strong>âŒ æ•°æ®åº“è¿æ¥å¤±è´¥</strong><br>
            ${error.message}
          </div>
        `;
      }
    }

    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    async function showStats() {
      try {
        const db = await openDB();
        const tx = db.transaction(['books', 'bookContent', 'readingProgress'], 'readonly');
        
        const booksCount = await new Promise((resolve) => {
          const request = tx.objectStore('books').count();
          request.onsuccess = () => resolve(request.result);
        });

        const contentCount = await new Promise((resolve) => {
          const request = tx.objectStore('bookContent').count();
          request.onsuccess = () => resolve(request.result);
        });

        const progressCount = await new Promise((resolve) => {
          const request = tx.objectStore('readingProgress').count();
          request.onsuccess = () => resolve(request.result);
        });

        document.getElementById('stats').innerHTML = `
          <div class="stat">
            <div class="stat-label">ä¹¦ç±æ•°é‡</div>
            <div class="stat-value">${booksCount}</div>
          </div>
          <div class="stat">
            <div class="stat-label">å†…å®¹è®°å½•</div>
            <div class="stat-value">${contentCount}</div>
          </div>
          <div class="stat">
            <div class="stat-label">è¿›åº¦è®°å½•</div>
            <div class="stat-value">${progressCount}</div>
          </div>
        `;

        db.close();
      } catch (error) {
        document.getElementById('stats').innerHTML = `
          <div class="error-box">æ— æ³•è·å–ç»Ÿè®¡ä¿¡æ¯: ${error.message}</div>
        `;
      }
    }

    // åˆ—å‡ºæ‰€æœ‰ä¹¦ç±
    async function listBooks() {
      const result = document.getElementById('result');
      result.innerHTML = '<div class="info-box">æ­£åœ¨åŠ è½½ä¹¦ç±åˆ—è¡¨...</div>';

      try {
        const db = await openDB();
        const tx = db.transaction('books', 'readonly');
        const store = tx.objectStore('books');
        
        const books = await new Promise((resolve, reject) => {
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });

        if (books.length === 0) {
          result.innerHTML = '<div class="info-box">æ•°æ®åº“ä¸­æ²¡æœ‰ä¹¦ç±</div>';
        } else {
          let html = `
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>æ ‡é¢˜</th>
                  <th>ä½œè€…</th>
                  <th>æ ¼å¼</th>
                  <th>è¿›åº¦</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
          `;

          books.forEach(book => {
            html += `
              <tr>
                <td><code>${book.id}</code></td>
                <td>${book.title}</td>
                <td>${book.author}</td>
                <td>${book.format.toUpperCase()}</td>
                <td>${book.progress.toFixed(1)}%</td>
                <td>
                  <button class="secondary" onclick="viewBookContent('${book.id}')">æŸ¥çœ‹å†…å®¹</button>
                  <button class="danger" onclick="deleteBook('${book.id}')">åˆ é™¤</button>
                </td>
              </tr>
            `;
          });

          html += '</tbody></table>';
          result.innerHTML = html;
        }

        db.close();
      } catch (error) {
        result.innerHTML = `
          <div class="error-box">
            <strong>âŒ åŠ è½½å¤±è´¥</strong><br>
            ${error.message}
          </div>
        `;
      }
    }

    // æŸ¥çœ‹ä¹¦ç±å†…å®¹
    async function viewBookContent(bookId) {
      const result = document.getElementById('result');
      result.innerHTML = '<div class="info-box">æ­£åœ¨åŠ è½½ä¹¦ç±å†…å®¹...</div>';

      try {
        const db = await openDB();
        const tx = db.transaction('bookContent', 'readonly');
        const store = tx.objectStore('bookContent');
        
        const contentData = await new Promise((resolve, reject) => {
          const request = store.get(bookId);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });

        if (!contentData) {
          result.innerHTML = `
            <div class="error-box">
              <strong>âŒ æœªæ‰¾åˆ°ä¹¦ç±å†…å®¹</strong><br>
              ä¹¦ç± ID: ${bookId}
            </div>
          `;
        } else {
          const content = JSON.parse(contentData.content);
          result.innerHTML = `
            <div class="success-box">
              <strong>âœ… ä¹¦ç±å†…å®¹ä¿¡æ¯</strong><br>
              ä¹¦ç± ID: ${bookId}<br>
              æ ¼å¼: ${content.format}<br>
              ç« èŠ‚æ•°é‡: ${content.chapters.length}<br>
              æ›´æ–°æ—¶é—´: ${new Date(contentData.updatedAt).toLocaleString()}
            </div>
            <h3>ç« èŠ‚åˆ—è¡¨</h3>
            <pre>${JSON.stringify(content.chapters.map(ch => ({
              id: ch.id,
              title: ch.title,
              contentLength: ch.content.length,
              order: ch.order
            })), null, 2)}</pre>
          `;
        }

        db.close();
      } catch (error) {
        result.innerHTML = `
          <div class="error-box">
            <strong>âŒ åŠ è½½å¤±è´¥</strong><br>
            ${error.message}
          </div>
        `;
      }
    }

    // æ£€æŸ¥æ‰€æœ‰ä¹¦ç±å†…å®¹
    async function checkBookContent() {
      const result = document.getElementById('result');
      result.innerHTML = '<div class="info-box">æ­£åœ¨æ£€æŸ¥æ‰€æœ‰ä¹¦ç±å†…å®¹...</div>';

      try {
        const db = await openDB();
        
        // è·å–æ‰€æœ‰ä¹¦ç±
        const booksTx = db.transaction('books', 'readonly');
        const books = await new Promise((resolve) => {
          const request = booksTx.objectStore('books').getAll();
          request.onsuccess = () => resolve(request.result);
        });

        // æ£€æŸ¥æ¯æœ¬ä¹¦çš„å†…å®¹
        const contentTx = db.transaction('bookContent', 'readonly');
        const contentStore = contentTx.objectStore('bookContent');

        const results = [];
        for (const book of books) {
          const contentData = await new Promise((resolve) => {
            const request = contentStore.get(book.id);
            request.onsuccess = () => resolve(request.result);
          });

          if (contentData) {
            try {
              const content = JSON.parse(contentData.content);
              results.push({
                id: book.id,
                title: book.title,
                hasContent: true,
                chaptersCount: content.chapters.length,
                totalContentLength: content.chapters.reduce((sum, ch) => sum + ch.content.length, 0)
              });
            } catch (e) {
              results.push({
                id: book.id,
                title: book.title,
                hasContent: true,
                error: 'å†…å®¹è§£æå¤±è´¥: ' + e.message
              });
            }
          } else {
            results.push({
              id: book.id,
              title: book.title,
              hasContent: false,
              error: 'å†…å®¹è®°å½•ä¸å­˜åœ¨'
            });
          }
        }

        let html = '<h3>ä¹¦ç±å†…å®¹æ£€æŸ¥ç»“æœ</h3><table><thead><tr><th>ä¹¦å</th><th>çŠ¶æ€</th><th>ç« èŠ‚æ•°</th><th>æ€»å­—æ•°</th></tr></thead><tbody>';
        results.forEach(r => {
          const status = r.error ? `<span style="color: #dc2626;">${r.error}</span>` : 
                        r.hasContent ? '<span style="color: #16a34a;">âœ… æ­£å¸¸</span>' : 
                        '<span style="color: #dc2626;">âŒ æ— å†…å®¹</span>';
          html += `
            <tr>
              <td>${r.title}</td>
              <td>${status}</td>
              <td>${r.chaptersCount || '-'}</td>
              <td>${r.totalContentLength ? r.totalContentLength.toLocaleString() : '-'}</td>
            </tr>
          `;
        });
        html += '</tbody></table>';

        result.innerHTML = html;
        db.close();
      } catch (error) {
        result.innerHTML = `
          <div class="error-box">
            <strong>âŒ æ£€æŸ¥å¤±è´¥</strong><br>
            ${error.message}
          </div>
        `;
      }
    }

    // åˆ é™¤ä¹¦ç±
    async function deleteBook(bookId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
        return;
      }

      try {
        const db = await openDB();
        const tx = db.transaction(['books', 'bookContent', 'readingProgress'], 'readwrite');
        
        await Promise.all([
          new Promise((resolve) => {
            const request = tx.objectStore('books').delete(bookId);
            request.onsuccess = () => resolve();
          }),
          new Promise((resolve) => {
            const request = tx.objectStore('bookContent').delete(bookId);
            request.onsuccess = () => resolve();
          }),
          new Promise((resolve) => {
            const request = tx.objectStore('readingProgress').delete(bookId);
            request.onsuccess = () => resolve();
          })
        ]);

        db.close();
        alert('åˆ é™¤æˆåŠŸï¼');
        listBooks();
        showStats();
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    // å¯¼å‡ºæ•°æ®
    async function exportData() {
      try {
        const db = await openDB();
        const tx = db.transaction(['books', 'bookContent'], 'readonly');
        
        const books = await new Promise((resolve) => {
          const request = tx.objectStore('books').getAll();
          request.onsuccess = () => resolve(request.result);
        });

        const contents = await new Promise((resolve) => {
          const request = tx.objectStore('bookContent').getAll();
          request.onsuccess = () => resolve(request.result);
        });

        const data = {
          exportTime: new Date().toISOString(),
          books,
          contents
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ebook-data-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);

        db.close();
        alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
      } catch (error) {
        alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
      }
    }

    // æ¸…ç©ºæ•°æ®åº“
    async function clearDatabase() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
        return;
      }

      if (!confirm('å†æ¬¡ç¡®è®¤ï¼šæ¸…ç©ºåæ‰€æœ‰ä¹¦ç±å’Œé˜…è¯»è¿›åº¦å°†æ°¸ä¹…ä¸¢å¤±ï¼')) {
        return;
      }

      try {
        const request = indexedDB.deleteDatabase(DB_NAME);
        request.onsuccess = () => {
          alert('æ•°æ®åº“å·²æ¸…ç©ºï¼é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ã€‚');
          location.reload();
        };
        request.onerror = () => {
          alert('æ¸…ç©ºå¤±è´¥: ' + request.error.message);
        };
      } catch (error) {
        alert('æ¸…ç©ºå¤±è´¥: ' + error.message);
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç»Ÿè®¡
    window.onload = () => {
      showStats();
    };
  </script>
</body>
</html>
