# 书籍内容显示问题诊断

## 问题现象

打开电子书后显示"暂无内容"或"无法加载书籍内容"。

## 可能的原因

### 1. 书籍导入时解析失败
- EPUB/PDF 解析库加载失败
- 文件格式不正确或损坏
- 章节提取失败

### 2. 数据保存失败
- IndexedDB 存储失败
- 内容序列化失败
- 浏览器存储空间不足

### 3. 数据读取失败
- IndexedDB 读取错误
- 内容反序列化失败
- 数据库版本不匹配

## 诊断步骤

### 步骤 1：打开浏览器开发者工具

1. 按 `F12` 打开开发者工具
2. 切换到 "Console"（控制台）标签
3. 查看是否有红色错误信息

### 步骤 2：查看调试日志

在控制台中查找以下日志：

```
bookService: 开始导入书籍 <文件名>
bookService: 解析 TXT/EPUB/PDF 文件
bookService: 解析完成，书籍信息 = {...}
bookService: 内容章节数 = <数字>
bookService: 保存成功
```

```
bookStore: 开始打开书籍，bookId = <ID>
bookStore: 获取到书籍信息 = {...}
bookStore: 获取到书籍内容 = {...}
```

```
ReaderPage: currentBook = {...}
ReaderPage: currentBookContent = {...}
ReaderPage: 章节数量 = <数字>
```

### 步骤 3：检查 IndexedDB 数据

1. 在开发者工具中切换到 "Application"（应用）标签
2. 展开左侧的 "IndexedDB"
3. 查找 "ebook-reader-db" 数据库
4. 检查以下表：
   - `books` - 应该有书籍记录
   - `bookContent` - 应该有对应的内容记录
5. 点击表名查看数据

### 步骤 4：检查错误信息

如果有错误，记录以下信息：
1. 错误类型（红色的错误信息）
2. 错误堆栈（Stack trace）
3. 发生错误的文件和行号

## 常见问题和解决方案

### 问题 1：PDF.js Worker 加载失败

**症状**：控制台显示 `Setting up fake worker` 或 worker 相关错误

**解决方案**：
1. 检查网络连接（需要从 CDN 加载 worker）
2. 或下载 PDF.js worker 文件到本地

### 问题 2：EPUB 解析库加载失败

**症状**：导入 EPUB 文件时报错

**解决方案**：
1. 检查 `epubjs` 是否正确安装
2. 运行 `npm install epubjs` 重新安装

### 问题 3：章节数为 0

**症状**：日志显示 "内容章节数 = 0"

**解决方案**：
- **TXT 文件**：检查文件是否包含章节标记（如"第一章"、"Chapter 1"）
- **EPUB 文件**：检查文件格式是否正确
- **PDF 文件**：检查 PDF 是否可读（不是图片 PDF）

### 问题 4：IndexedDB 存储失败

**症状**：保存时报错或数据为空

**解决方案**：
1. 清除浏览器缓存和 IndexedDB
2. 检查浏览器存储配额
3. 尝试使用隐私模式/无痕模式

## 测试建议

### 创建测试用 TXT 文件

创建一个简单的测试文件 `test.txt`：

```
作者：测试作者

第一章 开始

这是第一章的内容。这是一个测试段落。

这是另一个段落。

第二章 继续

这是第二章的内容。测试段落继续。

结束。
```

### 导入流程测试

1. 在开始页面点击"导入新书"
2. 选择测试文件
3. 观察控制台日志
4. 查看是否成功显示在书籍列表
5. 点击书籍卡片打开
6. 检查是否正常显示内容

## 清理数据（如果需要）

如果需要重新开始，可以清理所有数据：

1. 打开开发者工具
2. 切换到 "Console" 标签
3. 输入并执行：

```javascript
// 清空所有书籍数据
const request = indexedDB.deleteDatabase('ebook-reader-db');
request.onsuccess = () => console.log('数据库已删除');
request.onerror = () => console.log('删除失败');
```

4. 刷新页面

## 获取帮助

如果问题仍然存在，请提供：
1. 控制台的完整错误日志（截图或复制文本）
2. IndexedDB 中的数据截图
3. 尝试导入的文件类型和大小
4. 浏览器类型和版本
